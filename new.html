<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master Blueprint: The Scalable School Attendance System</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; line-height: 1.7; margin: 0; padding: 0; background-color: #f9fafb; color: #1f2937; }
        header { background: linear-gradient(90deg, #1e3a8a, #3b82f6); color: white; padding: 2.5rem; text-align: center; border-bottom: 5px solid #1d4ed8; }
        header h1 { margin: 0; font-size: 2.8rem; font-weight: 700; }
        nav { position: sticky; top: 0; background-color: #111827; z-index: 1000; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        nav ul { list-style-type: none; margin: 0; padding: 0; display: flex; justify-content: center; flex-wrap: wrap; }
        nav ul li a { color: white; text-decoration: none; padding: 1rem 1.5rem; display: block; transition: background-color 0.3s; font-weight: 500; }
        nav ul li a:hover { background-color: #374151; }
        .container { max-width: 1100px; margin: 2.5rem auto; padding: 0 1.5rem; }
        section { background-color: #ffffff; border-radius: 10px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05); margin-bottom: 2.5rem; padding: 2.5rem; }
        h2 { border-bottom: 3px solid #3b82f6; padding-bottom: 0.8rem; color: #1e3a8a; font-size: 2rem; margin-top:0; }
        h3 { font-size: 1.6rem; color: #1f2937; margin-top: 2rem; }
        pre { background-color: #111827; color: #f3f4f6; padding: 1.5rem; border-radius: 8px; overflow-x: auto; border-left: 6px solid #3b82f6; font-size: 0.95rem; }
        .note, .warning, .success, .action { padding: 1.5rem; border-radius: 8px; margin: 1.5rem 0; border-left-width: 6px; border-left-style: solid; }
        .note { background-color: #eff6ff; border-color: #3b82f6; }
        .warning { background-color: #fffbeb; border-color: #f59e0b; }
        .success { background-color: #f0fdf4; border-color: #22c55e; }
        .action { background-color: #f3e8ff; border-color: #9333ea; }
        table { width: 100%; border-collapse: collapse; margin: 1.5rem 0; }
        th, td { text-align: left; padding: 1rem; border-bottom: 1px solid #e5e7eb; }
        th { background-color: #f3f4f6; font-weight: 600; }
        .diagram { font-family: monospace; font-size: 0.9rem; line-height: 1.4; background-color: #f3f4f6; padding: 1.5rem; border-radius: 8px; }
    </style>
</head>
<body>

    <header>
        <h1>Master Blueprint: The Scalable School Attendance System</h1>
    </header>

    <nav>
        <ul>
            <li><a href="#summary">1. Architecture</a></li>
            <li><a href="#sdk-deep-dive">2. SDK Deep Dive</a></li>
            <li><a href="#infrastructure">3. Infrastructure</a></li>
            <li><a href="#database">4. Database Schema</a></li>
            <li><a href="#api-reference">5. API Reference</a></li>
            <li><a href="#execution-plan">6. Execution Plan</a></li>
            <li><a href="#onboarding">7. Onboarding Schools</a></li>
            <li><a href="#scenarios">8. Real-World Scenarios</a></li>
        </ul>
    </nav>

    <div class="container">

        <section id="summary">
            <h2>1. Core Architecture & Executive Summary</h2>
            <p>This document is the single source of truth for building, deploying, and scaling the School Attendance System. It provides a complete, A-to-Z execution plan.</p>
            <h3>1.1 Foundational Principles</h3>
            <ol>
                <li><strong>Central Brain Architecture:</strong> A single <strong>"Device Manager Script"</strong> runs on our central VPS. This "Brain" proactively manages all hardware devices (The "Arms"), creating a scalable hub-and-spoke model.</li>
                <li><strong>Hardware Standardization:</strong> To ensure simplicity and rapid scaling, we will standardize on one hardware model: the <strong>ZKTeco K40 Pro</strong>.</li>
                <li><strong>DDNS for Robust Connectivity:</strong> We will use a professional **Dynamic DNS (DDNS)** service to give each school's network a permanent, unchanging hostname (e.g., <code>school-a.ddns.net</code>). This makes the system resilient to changing IP addresses.</li>
                <li><strong>Decoupled Frontends:</strong> The Super Admin and School Admin dashboards are separate React applications, deployed on Vercel for global speed and reliability.</li>
            </ol>
            <h3>1.2 Final System Architecture Diagram</h3>
            <div class="diagram">
<pre>
+-------------------------------------------------------------------------------+
|                                YOUR VPS (CLOUD)                               |
|       Domain: api.yourattendanceservice.com -> [VPS Public IP]                |
|                                                                               |
| +-------------------------+   +---------------------------------------------+ |
| |   Backend API (Node.js) |   |   ZKTeco Manager Script (The "Brain")       | |
| |   (Listens for Logs)    |   |   (Runs 24/7 with PM2, uses ZKTeco SDK)     | |
| +-------------------------+   +---------------------------------------------+ |
|             ^                                   |                             |
+-------------|-----------------------------------|-----------------------------+
              | (Real-time Logs sent via HTTP POST) | (Smart Commands sent via TCP)
              |                                   |
              |                   THE INTERNET    |
              |                                   |
+-------------|-----------------------------------|-----------------------------+
|             v                                   v                             |
|  +-------------------------------------------------------------------------+  |
|  |                    SCHOOL NETWORK (e.g., School A)                      |  |
|  |                                                                         |  |
|  |  Public IP (Changes Daily) &lt;--- Hostname: school-a.ddns.net (Static)    |  |
|  |                                                                         |  |
|  |  +-----------------+  Port Forwarding Rule: Port 4370 -> [Device IP]   |  |
|  |  | Internet Router |                                                   |  |
|  |  +-----------------+                                                   |  |
|  |          | (Ethernet Cable - MANDATORY)                                 |  |
|  |          v                                                              |  |
|  |  +-----------------+                                                   |  |
|  |  | ZKTeco K40 Pro  |                                                   |  |
|  |  | (The "Arm")     |                                                   |  |
|  |  +-----------------+                                                   |  |
|  +-------------------------------------------------------------------------+  |
</pre>
            </div>
        </section>

        <section id="sdk-deep-dive">
            <h2>2. SDK Deep Dive: The "Why" and "How"</h2>
            <p>This section explains the critical role of the SDK and why it is essential for the advanced features of your system.</p>
            <h3>2.1 The Core Problem: Two Types of Communication</h3>
            <div class="warning"><strong>The central challenge:</strong> The ZKTeco machine can only be programmed to automatically "push" data to **one single URL**. This is perfect for real-time logs but is useless for all other "smart" features like health checks or data syncs.</div>
            <p>To solve this, we must have two distinct communication methods:</p>
            <ul>
                <li><strong>PUSH (Machine ‚û°Ô∏è Server):</strong> The machine initiates the connection to send real-time attendance logs. This is simple and fast.</li>
                <li><strong>PULL / COMMAND (Server ‚û°Ô∏è Machine):</strong> Our central server must initiate the connection to give the machine commands. This is complex and requires a special "translator."</li>
            </ul>
            
            <h3>2.2 The Solution: The SDK as a Private Remote Control</h3>
            <p>An **SDK (Software Development Kit)** is a library that acts as a translator and a remote control, allowing your server to speak the machine's private, proprietary language.</p>
            <ul>
                <li><strong>Your Backend API is a Mailbox üì¨:</strong> It passively waits to receive "letters" (HTTP POST requests) from the machine. It cannot start a conversation.</li>
                <li><strong>Your SDK Script is a Walkie-Talkie üìû:</strong> It proactively makes a "phone call" (a direct TCP connection) to the machine and gives it commands. It is the only way for your server to initiate a conversation.</li>
            </ul>

            <h3>2.3 The Tool for the Job: `node-zklib`</h3>
            <p>We will use the <code>node-zklib</code> library, a community-built SDK compatible with the ZKTeco K40 Pro. It translates your simple JavaScript commands into the complex TCP protocol the machine understands.</p>
            
            <h3>2.4 Core SDK Commands and Their Purpose</h3>
            <table>
                <thead>
                    <tr>
                        <th>SDK Command</th>
                        <th>Purpose</th>
                        <th>How Your System Uses It</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>getTime()</code></td>
                        <td>Get the device's internal time.</td>
                        <td><strong>Health Check.</strong> If this command succeeds, the device is online. The script updates the `last_seen` timestamp in the database.</td>
                    </tr>
                    <tr>
                        <td><code>getAttendances()</code></td>
                        <td>Download all attendance logs stored in the device's memory.</td>
                        <td><strong>Offline Sync.</strong> The script uses this to retrieve logs that were missed during an internet outage.</td>
                    </tr>
                    <tr>
                        <td><code>clearAttendance()</code></td>
                        <td>Delete all logs from the device's memory.</td>
                        <td>Used after a successful offline sync to free up space and prevent duplicate uploads.</td>
                    </tr>
                    <tr>
                        <td><code>getUsers()</code></td>
                        <td>Download all users (students/staff) stored on the device.</td>
                        <td><strong>User List Sync.</strong> The script compares this list with the main database to add/remove users from the device for offline verification.</td>
                    </tr>
                    <tr>
                        <td><code>setUser()</code> / <code>deleteUser()</code></td>
                        <td>Add or remove a user on the device.</td>
                        <td>Used during the User List Sync process.</td>
                    </tr>
                    <tr>
                        <td><code>disconnect()</code></td>
                        <td>Cleanly close the connection.</td>
                        <td><strong>CRITICAL.</strong> This must be called after every session to prevent the device from getting stuck.</td>
                    </tr>
                </tbody>
            </table>
        </section>

        <section id="infrastructure">
            <h2>3. Infrastructure & Services Procurement</h2>
            <p>This is the complete shopping list for your project.</p>
            <table>
                <thead>
                    <tr>
                        <th>Service</th>
                        <th>Recommendation</th>
                        <th>Plan & Cost</th>
                        <th>Justification</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>VPS (Server)</strong></td>
                        <td>DigitalOcean</td>
                        <td><strong>Basic Droplet, 2GB RAM / 1 vCPU</strong> (~$12/month)</td>
                        <td>Reliable, developer-friendly, and provides enough power to run the API, Database, and Manager Script.</td>
                    </tr>
                    <tr>
                        <td><strong>Domain Name</strong></td>
                        <td>Namecheap / GoDaddy</td>
                        <td>~ $15/year</td>
                        <td>Essential for a professional service. Provides a static, memorable address for your API (e.g., <code>api.yourattendanceservice.com</code>).</td>
                    </tr>
                    <tr>
                        <td><strong>DDNS Service</strong></td>
                        <td>No-IP</td>
                        <td><strong>Enhanced DNS</strong> (~$2.99/month)</td>
                        <td>Perfect for the pilot phase. Hostnames never expire, providing professional reliability. Can be upgraded to the "Pro" plan later for more hostnames.</td>
                    </tr>
                    <tr>
                        <td><strong>Frontend Hosting</strong></td>
                        <td>Vercel</td>
                        <td><strong>Hobby (Free Tier)</strong></td>
                        <td>Industry standard for hosting React apps. Offers global speed, automatic deployments, and is free to start.</td>
                    </tr>
                </tbody>
            </table>
        </section>

        <section id="database">
            <h2>4. Database Schema for Scale</h2>
            <p>The `devices` table is the heart of the Central Brain. Here is the required `CREATE TABLE` statement.</p>
            <pre><code>
-- This table stores not only the device's identity, but its network address and health status.
CREATE TABLE devices (
    id SERIAL PRIMARY KEY,
    school_id INTEGER NOT NULL REFERENCES schools(id) ON DELETE CASCADE,
    serial_number VARCHAR(255) NOT NULL UNIQUE,
    device_name VARCHAR(255) NOT NULL,
    location VARCHAR(255),
    is_active BOOLEAN DEFAULT TRUE,
    
    -- Columns for the "Central Brain" to connect
    hostname VARCHAR(255) UNIQUE, -- e.g., 'school-a.ddns.net'
    comm_port INTEGER DEFAULT 4370,   -- The port for the SDK connection
    
    -- Columns updated by the "Central Brain"
    status VARCHAR(50) DEFAULT 'unknown', -- 'online', 'offline', 'unknown'
    last_seen TIMESTAMP WITH TIME ZONE,
    
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);
            </code></pre>
        </section>
        
        <section id="api-reference">
            <h2>5. Complete API Endpoint Reference & Their Roles</h2>
            <p>This clarifies the purpose of every API endpoint in the final architecture.</p>
            <div class="note"><strong>Key Concept:</strong> The "smart" device APIs (e.g., `/sync/heartbeat`) are **not** called by the machine directly. They are helper endpoints used by your SDK Manager Script to report back to your central database.</div>
            <h3>Authentication (`/api/v1/auth`)</h3>
            <ul>
                <li><code>POST /login</code>: User login for all roles.</li>
                <li><code>POST /refresh</code>: Refresh access token.</li>
            </ul>
            <h3>Super Admin (`/api/v1/super`)</h3>
            <ul>
                <li><code>POST /devices</code>: Register a new device and its network details (`hostname`).</li>
                <li><code>GET /devices</code>: Get a list of all devices and their health status (`last_seen`, `status`).</li>
            </ul>
            <h3>School Admin (`/api/v1/school`)</h3>
            <ul>
                <li><code>POST /students</code>: Create a new student.</li>
                <li><code>GET /students</code>: Get a list of students for the admin's school.</li>
                <li><code>GET /dashboard/today</code>: Get today's attendance statistics.</li>
            </ul>
            <h3>Device Communication (The Two Systems)</h3>
            <h4>System 1: The Mailbox (Real-time Push)</h4>
            <ul>
                <li><strong><code>POST /api/v1/attendance/log</code></strong>: The one and only endpoint the ZKTeco machine calls directly to push a real-time attendance log.</li>
            </ul>
            <h4>System 2: The Remote Control Helpers (Used by the SDK Script)</h4>
            <ul>
                <li><strong><code>POST /api/v1/device/sync/logs</code></strong>: Used by the SDK script to upload a batch of offline logs it retrieved from a device.</li>
                <li><strong><code>POST /api/v1/device/sync/heartbeat</code> (or direct DB update)</strong>: An endpoint the SDK script can call to report a successful health check.</li>
            </ul>
        </section>

        <section id="execution-plan">
            <h2>6. The 0-100% Execution Plan</h2>
            <p>A phase-by-phase guide to take your project from code to a live, production-ready system.</p>
            <h3>Phase A: VPS Setup & Production Deployment (4 Hours)</h3>
            <ol>
                <li>Purchase services and create your DigitalOcean Droplet (Ubuntu 22.04, 2GB RAM).</li>
                <li>Secure your server: create a non-root user and set up the `ufw` firewall.</li>
                <li>Install the software stack: Node.js, PM2, PostgreSQL, Nginx.</li>
                <li>Configure your domain to point `api.yourattendanceservice.com` to the VPS IP.</li>
                <li>Deploy your backend API code from GitHub.</li>
                <li>Start the API with PM2: <code>pm2 start src/server.js --name "Backend-API"</code>.</li>
                <li>Configure Nginx as a reverse proxy and secure your API with a free SSL certificate from Let's Encrypt using `certbot`.</li>
            </ol>
            <h3>Phase B: The Central Brain - Deployment (1 Hour)</h3>
            <ol>
                <li>On your VPS, create a separate project folder: `zteco-manager`.</li>
                <li>Create the `manager.js` script inside (full code provided previously).</li>
                <li>Install its dependencies: <code>npm install node-zklib pg node-cron dotenv</code>.</li>
                <li>Create its `.env` file with database credentials.</li>
                <li>Start the script with PM2: <code>pm2 start manager.js --name "ZKTeco-Manager"</code>.</li>
                <li>Make it persistent across server reboots: `pm2 startup` and `pm2 save`.</li>
            </ol>
            <h3>Phase C: Frontend Deployment (1 Hour)</h3>
            <ol>
                <li>Push your two React projects to separate GitHub repositories.</li>
                <li>Import the projects into Vercel.</li>
                <li>Set the `REACT_APP_API_URL` environment variable in Vercel to your live API URL: <code>https://api.yourattendanceservice.com/api/v1</code>.</li>
            </ol>
        </section>

        <section id="onboarding">
            <h2>7. The Scalable School Onboarding Process</h2>
            <p>This is your repeatable checklist for bringing every new school online.</p>
            <h3>Step 1: Central Admin Tasks (Your Job)</h3>
            <ol>
                <li><strong>Create DDNS Hostname:</strong> In your No-IP account, create a unique hostname for the new school (e.g., `springfield-elementary.ddns.net`).</li>
                <li><strong>Onboard in System:</strong> Using your Super Admin dashboard, create the school and register their ZKTeco device. Enter the DDNS hostname (`springfield-elementary.ddns.net`) and port (`4370`) into the device's record in your database.</li>
            </ol>
            <h3>Step 2: School-Side Setup (Official Instruction Sheet)</h3>
            <div class="action">You will provide this precise instruction sheet to the school's IT contact.</div>
            <div class="note" style="padding: 2rem; border: 1px solid #ddd;">
                <h4>Subject: ZKTeco Device & Network Configuration Guide</h4>
                <p>To connect your new attendance device, please complete the following one-time setup.</p>
                <ol>
                    <li><strong>Physical Connection:</strong> Connect the ZKTeco device to your router using an <strong>Ethernet cable</strong>. <em>Do not use Wi-Fi.</em></li>
                    <li><strong>Device Configuration (Real-time Logs):</strong>
                        <ul>
                            <li>On the device menu, navigate to <strong>Comm. > ADMS</strong>.</li>
                            <li>Enter the Server URL: <code>https://api.yourattendanceservice.com/api/v1/attendance/log</code></li>
                        </ul>
                    </li>
                    <li><strong>Device Configuration (Smart Features):</strong>
                        <ul>
                            <li>Go to <strong>Comm. > DDNS</strong>.</li>
                            <li>Enter the credentials we have provided for your school:
                                <ul>
                                    <li><strong>Hostname:</strong> <code>springfield-elementary.ddns.net</code></li>
                                    <li><strong>Username/Password:</strong> <em>[Your No-IP account credentials]</em></li>
                                </ul>
                            </li>
                        </ul>
                    </li>
                    <li><strong>Router Configuration (Smart Features):</strong>
                        <ul>
                            <li>Log in to your main internet router.</li>
                            <li>Create a <strong>Port Forwarding</strong> rule to allow our central server to communicate with the device for health checks:
                                <ul>
                                    <li><strong>External Port:</strong> 4370</li>
                                    <li><strong>Internal IP:</strong> <em>The local IP of the ZKTeco device (set a static DHCP reservation for this)</em></li>
                                    <li><strong>Internal Port:</strong> 4370</li>
                                    <li><strong>Protocol:</strong> TCP</li>
                                </ul>
                            </li>
                        </ul>
                    </li>
                </ol>
                <p>Once completed, please let us know. Thank you!</p>
            </div>
        </section>

        <section id="scenarios">
            <h2>8. Real-World Scenarios & Data Flow</h2>
            <p>This section illustrates how the system handles real-world events.</p>
            <h3>Scenario 1: A Student Checks In (Internet is ON)</h3>
            <ol>
                <li>Student scans card at the school.</li>
                <li>The ZKTeco's **ADMS feature** sends a `POST` request to your **Backend API** (`.../log`).</li>
                <li>Your API saves the log to the database.</li>
                <li>The School Admin dashboard, which polls the API for new data, shows the check-in within seconds.</li>
            </ol>

            <h3>Scenario 2: An Internet Outage Occurs</h3>
            <ol>
                <li>The school's internet goes down.</li>
                <li>A student scans their card. The ADMS `POST` request fails.</li>
                <li>The ZKTeco machine automatically saves the attendance log to its own **internal memory**.</li>
                <li>This repeats for every student who scans during the outage.</li>
            </ol>
            
            <h3>Scenario 3: The Internet Comes Back Online</h3>
            <ol>
                <li>The internet connection is restored.</li>
                <li>On its next 5-minute cycle, your **ZKTeco Manager Script** (The Brain) successfully connects to the school's device via its DDNS hostname and the Port Forwarding rule.</li>
                <li>The script uses the SDK command `getAttendances()` to pull all the stored logs from the machine.</li>
                <li>The script then sends a single, efficient batch `POST` request to your **Backend API** (`.../sync/logs`).</li>
                <li>Your API processes the batch and saves all the missed logs to the database.</li>
                <li>Finally, the script sends the `clearAttendance()` command via the SDK to the machine, wiping its memory.</li>
            </ol>
            <div class="success">This demonstrates the foolproof, self-healing nature of the architecture. No data is ever lost.</div>
        </section>

    </div>
</body>
</html>
