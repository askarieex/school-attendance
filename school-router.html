<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master Blueprint: The Scalable School Attendance System</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; line-height: 1.7; margin: 0; padding: 0; background-color: #f9fafb; color: #1f2937; }
        header { background: linear-gradient(90deg, #1e3a8a, #3b82f6); color: white; padding: 2.5rem; text-align: center; border-bottom: 5px solid #1d4ed8; }
        header h1 { margin: 0; font-size: 2.8rem; font-weight: 700; }
        nav { position: sticky; top: 0; background-color: #111827; z-index: 1000; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        nav ul { list-style-type: none; margin: 0; padding: 0; display: flex; justify-content: center; flex-wrap: wrap; }
        nav ul li a { color: white; text-decoration: none; padding: 1rem 1.5rem; display: block; transition: background-color 0.3s; font-weight: 500; }
        nav ul li a:hover { background-color: #374151; }
        .container { max-width: 1100px; margin: 2.5rem auto; padding: 0 1.5rem; }
        section { background-color: #ffffff; border-radius: 10px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05); margin-bottom: 2.5rem; padding: 2.5rem; }
        h2 { border-bottom: 3px solid #3b82f6; padding-bottom: 0.8rem; color: #1e3a8a; font-size: 2rem; margin-top:0; }
        h3 { font-size: 1.6rem; color: #1f2937; margin-top: 2rem; }
        pre { background-color: #111827; color: #f3f4f6; padding: 1.5rem; border-radius: 8px; overflow-x: auto; border-left: 6px solid #3b82f6; font-size: 0.95rem; }
        .note, .warning, .success, .action { padding: 1.5rem; border-radius: 8px; margin: 1.5rem 0; border-left-width: 6px; border-left-style: solid; }
        .note { background-color: #eff6ff; border-color: #3b82f6; }
        .warning { background-color: #fffbeb; border-color: #f59e0b; }
        .success { background-color: #f0fdf4; border-color: #22c55e; }
        .action { background-color: #f3e8ff; border-color: #9333ea; }
        table { width: 100%; border-collapse: collapse; margin: 1.5rem 0; }
        th, td { text-align: left; padding: 1rem; border-bottom: 1px solid #e5e7eb; }
        th { background-color: #f3f4f6; font-weight: 600; }
        .diagram { font-family: monospace; font-size: 0.9rem; line-height: 1.4; background-color: #f3f4f6; padding: 1.5rem; border-radius: 8px; }
    </style>
</head>
<body>

    <header>
        <h1>Master Blueprint: The Scalable School Attendance System</h1>
    </header>

    <nav>
        <ul>
            <li><a href="#summary">1. Architecture</a></li>
            <li><a href="#stack">2. Infrastructure</a></li>
            <li><a href="#database">3. Database Schema</a></li>
            <li><a href="#phase1">4. VPS & Deployment</a></li>
            <li><a href="#phase2">5. Onboarding Schools</a></li>
            <li><a href="#phase3">6. The Central Brain</a></li>
            <li><a href="#phase4">7. Frontend Deployment</a></li>
            <li><a href="#security">8. Security</a></li>
        </ul>
    </nav>

    <div class="container">

        <section id="summary">
            <h2>1. Core Architecture & Executive Summary</h2>
            <p>This document is the single source of truth for building, deploying, and scaling the School Attendance System. It provides a complete, A-to-Z execution plan.</p>
            <h3>1.1 Foundational Principles</h3>
            <ol>
                <li><strong>Central Brain Architecture:</strong> A single <strong>"Device Manager Script"</strong> (The Brain) runs on our central VPS. This script actively manages all hardware devices (The Arms), creating a scalable hub-and-spoke model.</li>
                <li><strong>Hardware Standardization:</strong> To ensure simplicity and rapid scaling, we will standardize on one hardware model: the <strong>ZKTeco K40 Pro</strong>. Supporting other brands is a future goal, not an initial requirement.</li>
                <li><strong>DDNS for Robust Connectivity:</strong> We will not require schools to purchase expensive static IP addresses. We will use a professional **Dynamic DNS (DDNS)** service to give each school's network a permanent, unchanging hostname. This makes the system resilient to network changes.</li>
                <li><strong>Decoupled Frontends:</strong> The Super Admin and School Admin dashboards are separate React applications, deployed on a specialized hosting service (Vercel) for global speed and reliability.</li>
            </ol>
            <h3>1.2 Final System Architecture Diagram</h3>
            <div class="diagram">
<pre>
+-------------------------------------------------------------------------------+
|                                YOUR VPS (CLOUD)                               |
|       Domain: api.yourattendanceservice.com -> [VPS Public IP]                |
|                                                                               |
| +-------------------------+   +---------------------------------------------+ |
| |   Backend API (Node.js) |   |   ZKTeco Manager Script (The "Brain")       | |
| |   (Listens for Logs)    |   |   (Runs 24/7 with PM2, uses ZKTeco SDK)     | |
| +-------------------------+   +---------------------------------------------+ |
|             ^                                   |                             |
+-------------|-----------------------------------|-----------------------------+
              | (Real-time Logs sent via HTTP POST) | (Smart Commands sent via TCP)
              |                                   |
              |                   THE INTERNET    |
              |                                   |
+-------------|-----------------------------------|-----------------------------+
|             v                                   v                             |
|  +-------------------------------------------------------------------------+  |
|  |                    SCHOOL NETWORK (e.g., School A)                      |  |
|  |                                                                         |  |
|  |  Public IP (Changes Daily) &lt;--- Hostname: school-a.ddns.net (Static)    |  |
|  |                                                                         |  |
|  |  +-----------------+  Port Forwarding Rule: Port 4370 -> [Device IP]   |  |
|  |  | Internet Router |                                                   |  |
|  |  +-----------------+                                                   |  |
|  |          | (Ethernet Cable - MANDATORY)                                 |  |
|  |          v                                                              |  |
|  |  +-----------------+                                                   |  |
|  |  | ZKTeco K40 Pro  |                                                   |  |
|  |  | (The "Arm")     |                                                   |  |
|  |  +-----------------+                                                   |  |
|  +-------------------------------------------------------------------------+  |
</pre>
            </div>
        </section>

        <section id="stack">
            <h2>2. Infrastructure & Technology Stack</h2>
            <p>This is the complete list of all software and services required to build and run the platform.</p>
            <h3>2.1 Core Technologies</h3>
            <ul>
                <li><strong>Backend:</strong> Node.js (v18+), Express.js</li>
                <li><strong>Database:</strong> PostgreSQL (v14+)</li>
                <li><strong>Frontends:</strong> React.js (v18+)</li>
                <li><strong>Standardized Hardware:</strong> ZKTeco K40 Pro</li>
                <li><strong>Device Communication SDK:</strong> `node-zklib` library</li>
            </ul>
            <h3>2.2 Required Service Purchases</h3>
            <table>
                <thead>
                    <tr>
                        <th>Service</th>
                        <th>Recommendation</th>
                        <th>Plan & Cost</th>
                        <th>Why This Choice?</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>VPS (Server)</strong></td>
                        <td>DigitalOcean</td>
                        <td>Basic Droplet, 2GB RAM (~$12/month)</td>
                        <td>Reliable, developer-friendly, and provides enough power to run the API, database, and Manager Script.</td>
                    </tr>
                    <tr>
                        <td><strong>Domain Name</strong></td>
                        <td>Namecheap / GoDaddy</td>
                        <td>~ $15/year</td>
                        <td>Provides a professional, static address for your API. Essential for security and reliability.</td>
                    </tr>
                    <tr>
                        <td><strong>DDNS Service</strong></td>
                        <td>No-IP</td>
                        <td><strong>Enhanced DNS</strong> (~$2.99/month)</td>
                        <td>Perfect for the pilot phase. Gives you professional, non-expiring hostnames for your first few schools.</td>
                    </tr>
                    <tr>
                        <td><strong>Frontend Hosting</strong></td>
                        <td>Vercel</td>
                        <td>Hobby (Free Tier)</td>
                        <td>The industry standard for hosting React apps. Offers global speed, automatic deployments from GitHub, and is free to start.</td>
                    </tr>
                </tbody>
            </table>
        </section>

        <section id="database">
            <h2>3. Database Schema for Scale</h2>
            <p>The database must be structured to support the Central Brain. Here are the required `CREATE TABLE` statements, including the necessary columns for remote device management.</p>
            <pre><code>
-- The 'devices' table is the most critical for the Central Brain.
CREATE TABLE devices (
    id SERIAL PRIMARY KEY,
    school_id INTEGER NOT NULL REFERENCES schools(id) ON DELETE CASCADE,
    serial_number VARCHAR(255) NOT NULL UNIQUE,
    device_name VARCHAR(255) NOT NULL,
    location VARCHAR(255),
    is_active BOOLEAN DEFAULT TRUE,
    
    -- Columns for the "Central Brain" to connect
    hostname VARCHAR(255) UNIQUE, -- e.g., 'school-a.ddns.net'
    comm_port INTEGER DEFAULT 4370,   -- The port for the SDK connection
    
    last_seen TIMESTAMP WITH TIME ZONE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- Other essential tables
CREATE TABLE schools (
    id SERIAL PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    -- ... other school details
);

CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    school_id INTEGER REFERENCES schools(id), -- Nullable for Super Admins
    email VARCHAR(255) NOT NULL UNIQUE,
    password_hash VARCHAR(255) NOT NULL,
    role VARCHAR(50) NOT NULL CHECK (role IN ('superadmin', 'school_admin', 'teacher', 'parent')),
    -- ... other user details
);

-- The rest of your tables (students, attendance_logs, etc.)
            </code></pre>
        </section>

        <section id="phase1">
            <h2>4. Phase 1: VPS Setup & Production Deployment</h2>
            <p>This phase covers the complete setup of your server from a bare OS to a fully deployed, secure, and production-ready backend.</p>

            <h3>Step 4.1: Initial Server Setup</h3>
            <ol>
                <li>Purchase the recommended DigitalOcean Droplet with <strong>Ubuntu 22.04</strong>.</li>
                <li>Connect via SSH: <code>ssh root@&lt;your_vps_ip_address&gt;</code></li>
                <li>Create a new non-root user for security:
                    <pre><code>adduser your_username
usermod -aG sudo your_username</code></pre>
                </li>
                <li>Log out and log back in as the new user: <code>ssh your_username@&lt;your_vps_ip_address&gt;</code></li>
            </ol>

            <h3>Step 4.2: Install and Configure Firewall</h3>
            <div class="warning"><strong>Security First:</strong> Never run a production server without a firewall.</div>
            <pre><code># UFW (Uncomplicated Firewall) is the standard for Ubuntu.
sudo ufw allow OpenSSH       # Allows you to continue using SSH
sudo ufw allow 80/tcp        # For standard HTTP traffic (Nginx)
sudo ufw allow 443/tcp       # For secure HTTPS traffic (Nginx)
sudo ufw allow 3001/tcp      # For your Node.js API (will be firewalled from public later)
sudo ufw allow 4370/tcp      # For the ZKTeco SDK connection
sudo ufw enable</code></pre>

            <h3>Step 4.3: Install All Required Software</h3>
            <p>Run these commands on your VPS to install Node.js, PM2, PostgreSQL, and Nginx (a web server we'll use as a reverse proxy).</p>
            <pre><code># Node.js, npm, PM2
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt-get install -y nodejs
sudo npm install pm2 -g

# PostgreSQL
sudo apt update
sudo apt install postgresql postgresql-contrib
# (Configure database and user as described in the previous section)

# Nginx Web Server
sudo apt install nginx</code></pre>

            <h3>Step 4.4: Deploy and Run the Backend API with PM2</h3>
            <ol>
                <li>Clone your backend project from GitHub.</li>
                <li>Install dependencies (`npm install`) and create your production `.env` file.</li>
                <li>Start the application with PM2. This keeps it running 24/7.
                    <pre><code>pm2 start src/server.js --name "Backend-API"</code></pre>
                </li>
            </ol>

            <h3>Step 4.5: Configure Nginx as a Reverse Proxy and Add HTTPS</h3>
            <div class="note"><strong>Why do this?</strong> Nginx is a high-performance web server that will sit in front of your Node.js app. It will handle incoming traffic and add a layer of security, including HTTPS/SSL encryption. Your API will now be accessible via the standard port 443 instead of 3001.</div>
            <ol>
                <li>Create a new Nginx configuration file: <code>sudo nano /etc/nginx/sites-available/your_api_domain</code></li>
                <li>Paste in this configuration:
<pre><code>server {
    listen 80;
    server_name api.yourattendanceservice.com;

    location / {
        proxy_pass http://localhost:3001;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }
}</code></pre>
                </li>
                <li>Enable the site: <code>sudo ln -s /etc/nginx/sites-available/your_api_domain /etc/nginx/sites-enabled/</code></li>
                <li>Install Certbot for free SSL from Let's Encrypt and automatically configure Nginx for HTTPS:
<pre><code>sudo apt install certbot python3-certbot-nginx
sudo certbot --nginx -d api.yourattendanceservice.com</code></pre>
                </li>
            </ol>
            <div class="success">Your backend API is now securely live at <strong>https</strong>://api.yourattendanceservice.com.</div>
        </section>

        <section id="phase2">
            <h2>5. Phase 2: The Scalable School Onboarding Process</h2>
            <p>This is your repeatable checklist for bringing a new school online.</p>

            <h3>5.1 Central Admin Tasks (Your Job)</h3>
            <ol>
                <li><strong>Create DDNS Hostname:</strong> In your No-IP account, create a new hostname (e.g., `pilot-school-a.ddns.net`).</li>
                <li><strong>Onboard in System:</strong> Using your Super Admin dashboard, create the school and register their device. Enter the DDNS hostname and port (4370) into the device's record.</li>
            </ol>

            <h3>5.2 School-Side Setup (Official Instruction Sheet)</h3>
            <div class="action">You will provide this precise instruction sheet to the school's IT contact.</div>
            <div class="note" style="padding: 2rem; border: 1px solid #ddd;">
                <h4>Subject: ZKTeco Device & Network Configuration</h4>
                <p>To connect your new attendance device, please complete the following one-time setup.</p>
                <ol>
                    <li><strong>Physical Connection:</strong> Connect the ZKTeco device to your router using an <strong>Ethernet cable</strong>. Do not use Wi-Fi.</li>
                    <li><strong>Device Configuration (ADMS - for Real-time Logs):</strong>
                        <ul>
                            <li>On the device menu, go to <strong>Comm. > ADMS</strong>.</li>
                            <li>Enter the Server URL: <code>https://api.yourattendanceservice.com/api/v1/attendance/log</code></li>
                        </ul>
                    </li>
                    <li><strong>Device Configuration (DDNS - for Smart Features):</strong>
                        <ul>
                            <li>Go to <strong>Comm. > DDNS</strong>.</li>
                            <li>Enter these credentials:
                                <ul>
                                    <li><strong>Hostname:</strong> <code>pilot-school-a.ddns.net</code></li>
                                    <li><strong>Username/Password:</strong> <em>[Your No-IP account credentials]</em></li>
                                </ul>
                            </li>
                        </ul>
                    </li>
                    <li><strong>Router Configuration (Port Forwarding):</strong>
                        <ul>
                            <li>Log in to your main internet router.</li>
                            <li>Create a <strong>Port Forwarding</strong> rule to allow our central server to communicate with the device for health checks and syncs:
                                <ul>
                                    <li><strong>Service/External Port:</strong> 4370</li>
                                    <li><strong>Internal IP:</strong> <em>The local IP of the ZKTeco device</em></li>
                                    <li><strong>Internal Port:</strong> 4370</li>
                                    <li><strong>Protocol:</strong> TCP</li>
                                </ul>
                            </li>
                        </ul>
                    </li>
                </ol>
                <p>Once completed, please let us know. Thank you!</p>
            </div>
        </section>

        <section id="phase3">
            <h2>6. Phase 3: The Central Brain (ZKTeco Manager Script)</h2>
            <p>This Node.js script runs on your VPS, managing all devices.</p>

            <h3>6.1 The Complete Script (`manager.js`)</h3>
            <p>Create this file in a new project folder on your VPS. It connects to your database, fetches the list of devices, and manages them on a schedule.</p>
            <pre><code>
const ZKLib = require('node-zklib');
const cron = require('node-cron');
const { Pool } = require('pg');
require('dotenv').config();

const dbPool = new Pool({
  user: process.env.DB_USER,
  host: process.env.DB_HOST,
  // ... your production DB credentials from .env
});

async function manageDevice(device) {
  let zkInstance = null;
  console.log(`[INFO] Managing device: ${device.device_name} at ${device.hostname}:${device.comm_port}`);

  try {
    zkInstance = new ZKLib(device.hostname, device.comm_port, 5000, 5000);
    await zkInstance.createSocket();
    console.log(`[SUCCESS] Connected to ${device.device_name}`);

    // TASK 1: Health Check (Heartbeat)
    const deviceTime = await zkInstance.getTime();
    console.log(`[HEALTH] Device time for ${device.device_name} is ${deviceTime}`);
    await dbPool.query('UPDATE devices SET last_seen = NOW(), status = $2 WHERE id = $1', [device.id, 'online']);

  } catch (e) {
    console.error(`[ERROR] Failed to manage ${device.device_name}: ${e.message}`);
    await dbPool.query('UPDATE devices SET status = $2 WHERE id = $1', [device.id, 'offline']);
  } finally {
    if (zkInstance) {
      await zkInstance.disconnect();
    }
  }
}

async function runManagerCycle() {
  console.log(`[CYCLE START] Running at ${new Date().toISOString()}`);
  const result = await dbPool.query('SELECT * FROM devices WHERE is_active = TRUE AND hostname IS NOT NULL');
  const allDevices = result.rows;
  console.log(`[INFO] Found ${allDevices.length} active devices to manage.`);

  // Use Promise.all to manage devices concurrently for better performance
  await Promise.all(allDevices.map(device => manageDevice(device)));

  console.log(`[CYCLE END] Cycle finished.`);
}

// Schedule to run every 5 minutes.
cron.schedule('*/5 * * * *', runManagerCycle);

console.log('✅ ZKTeco Manager Script started.');
            </code></pre>

            <h3>6.2 Deployment with PM2</h3>
            <ol>
                <li>Start the script: <code>pm2 start manager.js --name "ZKTeco-Manager"</code></li>
                <li>Make it restart on server reboot: <code>pm2 startup</code> (follow instructions) and then <code>pm2 save</code>.</li>
            </ol>
        </section>

        <section id="phase4">
            <h2>7. Phase 4: Frontend Deployment</h2>
            <p>Deploying your React frontends on Vercel is the final step.</p>
            <ol>
                <li>Push your two frontend projects to two separate GitHub repositories.</li>
                <li>Sign up for a Vercel account and connect it to GitHub.</li>
                <li>Import each project. Vercel will auto-detect the settings.</li>
                <li>In each project's settings on Vercel, add an Environment Variable:
                    <ul>
                        <li><strong>Name:</strong> <code>REACT_APP_API_URL</code></li>
                        <li><strong>Value:</strong> <code>https://api.yourattendanceservice.com/api/v1</code></li>
                    </ul>
                </li>
            </ol>
            <div class="success">Vercel will deploy your apps and provide live URLs. Any push to your `main` branch on GitHub will trigger a new automatic deployment.</div>
        </section>
        
        <section id="security">
            <h2>8. Security Best Practices Checklist</h2>
            <div class="warning">Security is not a feature; it's a foundation.</div>
            <ul>
                <li>✅ <strong>Use HTTPS Everywhere:</strong> Certbot/Let's Encrypt makes this easy and free.</li>
                <li>✅ <strong>Firewall Your VPS:</strong> Only open the necessary ports (SSH, HTTPS, and your SDK port).</li>
                <li>✅ <strong>Use Environment Variables:</strong> Never hardcode secrets like database passwords or API keys in your code. Use a <code>.env</code> file.</li>
                <li>✅ <strong>Strong Password Hashing:</strong> Your backend should use a strong hashing algorithm like `bcrypt` for all user passwords.</li>
                <li>✅ <strong>Regular Updates:</strong> Keep your server's OS (`sudo apt update && sudo apt upgrade`) and Node.js packages (`npm update`) up to date to patch security vulnerabilities.</li>
                <li>✅ <strong>Least Privilege Principle:</strong> Your database user should only have the permissions it needs. Don't use the `postgres` superuser for your application.</li>
            </ul>
        </section>

    </div>

</body>
</html>